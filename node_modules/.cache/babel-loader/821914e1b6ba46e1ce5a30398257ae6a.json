{"ast":null,"code":"import { interaction, animation, theme, scale, annotation, tooltip } from '../../adaptor/common';\nimport { flow, deepAssign } from '../../utils';\nimport { conversionTagFormatter } from '../../utils/conversion';\nimport { basicFunnel } from './geometries/basic';\nimport { compareFunnel } from './geometries/compare';\nimport { facetFunnel } from './geometries/facet';\nimport { dynamicHeightFunnel } from './geometries/dynamic-height';\nimport { FUNNEL_CONVERSATION, FUNNEL_MAPPING_VALUE, FUNNEL_PERCENT } from './constant';\n/**\n *\n * 各式漏斗图geometry实现细节有较大不同,\n * 1. 普通漏斗图：interval.shape('funnel')\n * 2. 对比漏斗图：分面\n * 3. 动态高度漏斗图：polypon\n * 4. 分面漏斗图：普通 + list 分面\n* /\n\n/**\n * options 处理\n * @param params\n */\n\nfunction defaultOptions(params) {\n  var _a;\n\n  var options = params.options;\n  var compareField = options.compareField,\n      xField = options.xField,\n      yField = options.yField;\n  var defaultOption = {\n    minSize: 0,\n    maxSize: 1,\n    meta: (_a = {}, _a[FUNNEL_MAPPING_VALUE] = {\n      min: 0,\n      max: 1,\n      nice: false\n    }, _a),\n    label: compareField ? {\n      fields: [xField, yField, compareField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n      style: {\n        fill: '#fff',\n        fontSize: 12\n      },\n      formatter: function (datum) {\n        return \"\" + datum[yField];\n      }\n    } : {\n      fields: [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n      offset: 0,\n      position: 'middle',\n      style: {\n        fill: '#fff',\n        fontSize: 12\n      },\n      formatter: function (datum) {\n        return datum[xField] + \" \" + datum[yField];\n      }\n    },\n    tooltip: {\n      showTitle: false,\n      showMarkers: false,\n      shared: false,\n      title: xField,\n      formatter: function (datum) {\n        return {\n          name: datum[xField],\n          value: datum[yField]\n        };\n      }\n    },\n    conversionTag: {\n      offsetX: 10,\n      offsetY: 0,\n      style: {},\n      // conversionTag 的计算和显示逻辑统一保持一致\n      formatter: function (datum) {\n        return \"\\u8F6C\\u5316\\u7387: \" + conversionTagFormatter.apply(void 0, datum[FUNNEL_CONVERSATION]);\n      }\n    }\n  };\n  return deepAssign({\n    options: defaultOption\n  }, params);\n}\n/**\n * geometry处理\n * @param params\n */\n\n\nfunction geometry(params) {\n  var options = params.options;\n  var compareField = options.compareField,\n      dynamicHeight = options.dynamicHeight,\n      seriesField = options.seriesField;\n\n  if (seriesField) {\n    return facetFunnel(params);\n  }\n\n  if (compareField) {\n    return compareFunnel(params);\n  }\n\n  if (dynamicHeight) {\n    return dynamicHeightFunnel(params);\n  }\n\n  return basicFunnel(params);\n}\n/**\n * meta 配置\n * @param params\n */\n\n\nexport function meta(params) {\n  var _a;\n\n  var options = params.options;\n  var xAxis = options.xAxis,\n      yAxis = options.yAxis,\n      xField = options.xField,\n      yField = options.yField;\n  return flow(scale((_a = {}, _a[xField] = xAxis, _a[yField] = yAxis, _a)))(params);\n}\n/**\n * 坐标轴\n * @param params\n */\n\nfunction axis(params) {\n  var chart = params.chart;\n  chart.axis(false);\n  return params;\n}\n/**\n * legend 配置\n * @param params\n */\n\n\nfunction legend(params) {\n  var chart = params.chart,\n      options = params.options;\n  var legend = options.legend;\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    chart.legend(legend); // TODO FIX: legend-click 时间和转化率组件之间的关联\n  }\n\n  return params;\n}\n/**\n * 漏斗图适配器\n * @param chart\n * @param options\n */\n\n\nexport function adaptor(params) {\n  return flow(defaultOptions, geometry, meta, axis, tooltip, interaction, legend, animation, theme, annotation())(params);\n}","map":{"version":3,"sources":["../../../src/plots/funnel/adaptor.ts"],"names":[],"mappings":"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","sourcesContent":["import { Params } from '../../core/adaptor';\nimport { interaction, animation, theme, scale, annotation, tooltip } from '../../adaptor/common';\nimport { flow, deepAssign } from '../../utils';\nimport { conversionTagFormatter } from '../../utils/conversion';\nimport { FunnelOptions } from './types';\nimport { basicFunnel } from './geometries/basic';\nimport { compareFunnel } from './geometries/compare';\nimport { facetFunnel } from './geometries/facet';\nimport { dynamicHeightFunnel } from './geometries/dynamic-height';\nimport { FUNNEL_CONVERSATION, FUNNEL_MAPPING_VALUE, FUNNEL_PERCENT } from './constant';\n\n/**\n *\n * 各式漏斗图geometry实现细节有较大不同,\n * 1. 普通漏斗图：interval.shape('funnel')\n * 2. 对比漏斗图：分面\n * 3. 动态高度漏斗图：polypon\n * 4. 分面漏斗图：普通 + list 分面\n* /\n\n/**\n * options 处理\n * @param params\n */\nfunction defaultOptions(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { compareField, xField, yField } = options;\n  const defaultOption = {\n    minSize: 0,\n    maxSize: 1,\n    meta: {\n      [FUNNEL_MAPPING_VALUE]: {\n        min: 0,\n        max: 1,\n        nice: false,\n      },\n    },\n    label: compareField\n      ? {\n          fields: [xField, yField, compareField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n          style: {\n            fill: '#fff',\n            fontSize: 12,\n          },\n          formatter: (datum) => `${datum[yField]}`,\n        }\n      : {\n          fields: [xField, yField, FUNNEL_PERCENT, FUNNEL_CONVERSATION],\n          offset: 0,\n          position: 'middle',\n          style: {\n            fill: '#fff',\n            fontSize: 12,\n          },\n          formatter: (datum) => `${datum[xField]} ${datum[yField]}`,\n        },\n    tooltip: {\n      showTitle: false,\n      showMarkers: false,\n      shared: false,\n      title: xField,\n      formatter: (datum) => {\n        return { name: datum[xField], value: datum[yField] };\n      },\n    },\n    conversionTag: {\n      offsetX: 10,\n      offsetY: 0,\n      style: {},\n      // conversionTag 的计算和显示逻辑统一保持一致\n      formatter: (datum) => `转化率: ${conversionTagFormatter(...(datum[FUNNEL_CONVERSATION] as [number, number]))}`,\n    },\n  };\n\n  return deepAssign(\n    {\n      options: defaultOption,\n    },\n    params\n  );\n}\n\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { compareField, dynamicHeight, seriesField } = options;\n  if (seriesField) {\n    return facetFunnel(params);\n  }\n  if (compareField) {\n    return compareFunnel(params);\n  }\n  if (dynamicHeight) {\n    return dynamicHeightFunnel(params);\n  }\n\n  return basicFunnel(params);\n}\n\n/**\n * meta 配置\n * @param params\n */\nexport function meta(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { options } = params;\n  const { xAxis, yAxis, xField, yField } = options;\n\n  return flow(\n    scale({\n      [xField]: xAxis,\n      [yField]: yAxis,\n    })\n  )(params);\n}\n\n/**\n * 坐标轴\n * @param params\n */\nfunction axis(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart } = params;\n  chart.axis(false);\n  return params;\n}\n\n/**\n * legend 配置\n * @param params\n */\nfunction legend(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { legend } = options;\n\n  if (legend === false) {\n    chart.legend(false);\n  } else {\n    chart.legend(legend);\n    // TODO FIX: legend-click 时间和转化率组件之间的关联\n  }\n\n  return params;\n}\n\n/**\n * 漏斗图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<FunnelOptions>) {\n  return flow(\n    defaultOptions,\n    geometry,\n    meta,\n    axis,\n    tooltip,\n    interaction,\n    legend,\n    animation,\n    theme,\n    annotation()\n  )(params);\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}